# Global Requirements Framework Configuration
# ============================================
# This is your personal default config for all projects.
# Projects can override these settings in their own .claude/requirements.yaml

version: "1.0"

# Framework enabled globally (projects can override)
enabled: true

# Default requirements (disabled by default - projects opt-in)
requirements:
  # Commit Plan Requirement
  # Ensures a commit plan exists before making code changes
  commit_plan:
    enabled: true
    type: blocking
    scope: session  # Resets each session (forces daily planning)
    description: "Ensures an atomic commit strategy exists before implementation."
    trigger_tools:
      - Edit
      - Write
      - MultiEdit
    auto_resolve_skill: "requirements-framework:arch-review"
    message: |
      ## Blocked: commit_plan

      **Execute**: `/{auto_resolve_skill}`

      Team-based architecture review with commit planning and cross-validation.

      ---
      Fallback: `req satisfy commit_plan`
    checklist:
      - "Identified the changes needed for this feature/fix"
      - "Determined atomic commit boundaries (each commit is reviewable)"
      - "Planned commit sequence and dependencies"

  # GitHub Ticket Requirement
  # Links work to GitHub issue tracking (disabled by default - opt-in)
  github_ticket:
    enabled: false  # Disabled by default - enable per project if using issue tracking
    type: blocking
    scope: branch  # Once per branch
    description: "Links work to GitHub issue tracking for traceability."
    trigger_tools:
      - Edit
      - Write
      - MultiEdit
    message: |
      ## Blocked: github_ticket

      No GitHub issue linked to this branch.

      **Action**: Link a GitHub issue to track this work.

      ---
      Fallback: `req satisfy github_ticket --metadata '{"ticket":"#1234"}'`
    checklist:
      - "Created GitHub issue for this work"
      - "Issue number linked to branch"

  # ADR Review Requirement
  # Ensures architectural decisions are reviewed before code changes
  adr_reviewed:
    enabled: true
    type: blocking
    scope: session
    description: "Ensures changes align with Architecture Decision Records."
    trigger_tools:
      - Edit
      - Write
      - MultiEdit
    auto_resolve_skill: "requirements-framework:arch-review"
    message: |
      ## Blocked: adr_reviewed

      **Execute**: `/{auto_resolve_skill}`

      Team-based ADR review with cross-validation against breaking changes and testability.

      ---
      Fallback: `req satisfy adr_reviewed`
    checklist:
      - "Searched for ADRs related to this change"
      - "Confirmed approach aligns with existing ADRs"

  # TDD Planning Requirement
  # Ensures the plan includes a TDD strategy and test cases per feature
  tdd_planned:
    enabled: true
    type: blocking
    scope: session
    description: "Ensures the plan includes TDD strategy and test cases per feature."
    trigger_tools:
      - Edit
      - Write
      - MultiEdit
    auto_resolve_skill: "requirements-framework:arch-review"
    message: |
      ## Blocked: tdd_planned

      **Execute**: `/{auto_resolve_skill}`

      Team-based TDD validation with cross-reference against breaking changes.

      ---
      Fallback: `req satisfy tdd_planned`
    checklist:
      - "Plan has a testing strategy section"
      - "Each feature identifies tests to write first"
      - "TDD sequence is documented"

  # SOLID Principles Review
  # Ensures the plan follows SOLID design principles
  solid_reviewed:
    enabled: true
    type: blocking
    scope: session
    description: "Ensures the plan follows SOLID principles with Python-specific patterns."
    trigger_tools:
      - Edit
      - Write
      - MultiEdit
    auto_resolve_skill: "requirements-framework:arch-review"
    message: |
      ## Blocked: solid_reviewed

      **Execute**: `/{auto_resolve_skill}`

      Team-based SOLID review with cross-validation against testability and ADRs.

      ---
      Fallback: `req satisfy solid_reviewed`
    checklist:
      - "Plan reviewed for Single Responsibility (no mixed concerns)"
      - "Extension points identified where applicable (Open/Closed)"
      - "Dependencies use abstractions not concretions (Dependency Inversion)"

  # Protected Branch Guard
  # Prevents direct edits on protected branches (main/master)
  protected_branch:
    enabled: true
    type: guard
    guard_type: protected_branch
    description: "Prevents direct edits on main/master branches."
    protected_branches:
      - master
      - main
    trigger_tools:
      - Edit
      - Write
      - MultiEdit
    message: |
      ## Blocked: protected_branch

      Cannot edit files on protected branch `{branch}`.

      **Actions**:
      1. Create feature branch: `git checkout -b feature/your-feature-name`
      2. Emergency override: `req approve protected_branch`
    checklist:
      - "Confirmed not on protected branch (master/main)"
      - "Feature branch created for changes"

  # Single Session Per Project Guard
  # Prevents multiple Claude Code sessions from editing the same project simultaneously
  single_session_per_project:
    enabled: false  # Opt-in per project - enable in .claude/requirements.yaml
    type: guard
    guard_type: single_session
    description: "Prevents multiple sessions from editing the same project simultaneously."
    scope: session  # Approval persists for the session
    trigger_tools:
      - Edit
      - Write
      - MultiEdit
    message: |
      ## Blocked: single_session_per_project

      Another Claude Code session is active on this project.

      **Actions**:
      1. Close the other session
      2. Wait for completion
      3. Override: `req approve single_session_per_project`
    checklist:
      - "Confirmed no other active sessions on this project"

  # Branch Size Limit (Dynamic Requirement)
  # Automatically calculates branch size and enforces limits
  branch_size_limit:
    enabled: true  # Enabled by default
    type: dynamic  # Calculated automatically, not manually satisfied
    calculator: branch_size_calculator  # References lib/branch_size_calculator.py
    description: "Automatically calculates branch size and enforces PR size limits."
    scope: session  # Approval persists for session
    trigger_tools:
      - Edit
      - Write
      - MultiEdit

    # Calculation cache to avoid running git on every edit
    cache_ttl: 60  # Recalculate every 60 seconds

    # Approval TTL when user manually approves via CLI
    approval_ttl: 3600  # 1 hour (increased from 5 minutes)

    # Thresholds for evaluation
    thresholds:
      warn: 250   # Log warning (non-blocking)
      block: 400  # Block with denial message

    # Message template (supports {variable} substitution)
    blocking_message: |
      ## Blocked: branch_size_limit

      Branch has **{total}** line changes (limit: {block_threshold}).

      {summary}

      **Recommendation**: Split into smaller, focused PRs after this session.

      ---
      Override: `req approve branch_size_limit`

  # Pre-Commit Review Requirement
  # Ensures code is reviewed before every commit
  pre_commit_review:
    enabled: true
    type: blocking
    scope: single_use  # Must re-satisfy before EACH commit
    description: "Code review before each commit - resets after commit completes."
    trigger_tools:
      - tool: Bash
        command_pattern: "git\\s+(commit|cherry-pick|revert|merge)"
    auto_resolve_skill: "requirements-framework:pre-commit"
    satisfied_by_skill: 'requirements-framework:pre-commit'
    message: |
      ## Blocked: pre_commit_review

      **Execute**: `/{auto_resolve_skill}`

      Runs code-reviewer, silent-failure-hunter, and tool-validator agents.

      ---
      Fallback: `req satisfy pre_commit_review`
    checklist:
      - "Code follows project conventions"
      - "Error handling is adequate"
      - "No obvious bugs or issues"

  # Pre-PR Review Requirement
  # Ensures comprehensive quality check before creating a PR
  pre_pr_review:
    enabled: true
    type: blocking
    scope: single_use  # Must re-satisfy for each PR creation
    description: "Comprehensive quality review with all review agents before PR creation."
    trigger_tools:
      - tool: Bash
        command_pattern: "gh\\s+pr\\s+create"
    auto_resolve_skill: "requirements-framework:deep-review"
    satisfied_by_skill: 'requirements-framework:deep-review'
    message: |
      ## Blocked: pre_pr_review

      **Execute**: `/{auto_resolve_skill}`

      Cross-validated team-based review with agent debate.

      ---
      Fallback: `req satisfy pre_pr_review`
    checklist:
      - "Code has been reviewed for bugs"
      - "Error handling is complete"
      - "Tests are adequate (if applicable)"

  # Codex AI Review Requirement
  # AI-powered code review before PR creation
  codex_reviewer:
    enabled: true
    type: blocking
    scope: single_use  # Must re-satisfy for each PR creation
    description: "AI-powered code review via OpenAI Codex CLI before PR creation."
    trigger_tools:
      - tool: Bash
        command_pattern: "gh\\s+pr\\s+create"
    auto_resolve_skill: "requirements-framework:codex-review"
    satisfied_by_skill: 'requirements-framework:codex-review'
    message: |
      ## Blocked: codex_reviewer

      **Execute**: `/{auto_resolve_skill}`

      AI-powered code review via OpenAI Codex CLI.

      ---
      Fallback: `req satisfy codex_reviewer`
    checklist:
      - "Codex CLI installed (npm install -g @openai/codex)"
      - "AI review completed"

# ============================================================================
# PLAN MODE TRIGGER EXAMPLES
# ============================================================================
# Requirements can trigger on plan mode transitions (EnterPlanMode, ExitPlanMode)
# This enables multi-phase workflows like ADR checking at planning time.
#
# Example: Multi-phase ADR compliance workflow
#
#   # Phase 1: Plan validation (after planning)
#   adr_plan_validation:
#     enabled: false  # Disabled by default - enable per project
#     type: blocking
#     scope: single_use  # Must re-satisfy for each plan
#     trigger_tools:
#       - ExitPlanMode  # ‚Üê Triggers when exiting plan mode
#     auto_resolve_skill: 'requirements-framework:plan-review'
#     satisfied_by_skill: 'adr-guardian'  # Auto-satisfied by adr-guardian agent
#     message: |
#       ## Blocked: adr_plan_validation
#
#       **Execute**: `/{auto_resolve_skill}`
#
#       Validates plan against ADRs before implementation.
#
#       ---
#       Fallback: `req satisfy adr_plan_validation`

# ============================================================================
# PROJECT-SPECIFIC SKILL REQUIREMENTS
# ============================================================================
# Projects can configure their own skills to auto-satisfy requirements using
# the 'satisfied_by_skill' field. This enables project-specific workflows
# without modifying the framework code.
#
# Example: In solarmonkey-app's .claude/requirements.yaml:
#
#   architecture_review:
#     enabled: true
#     type: blocking
#     scope: single_use
#     trigger_tools:
#       - tool: Bash
#         command_pattern: 'gh\s+pr\s+create'
#     auto_resolve_skill: 'architecture-guardian'  # ‚Üê Project-specific skill
#     satisfied_by_skill: 'architecture-guardian'
#     message: |
#       ## Blocked: architecture_review
#
#       **Execute**: `/architecture-guardian`
#
#       ---
#       Fallback: `req satisfy architecture_review`

# Hooks configuration
hooks:
  # SessionStart hook - injects requirement context at session start/resume
  session_start:
    inject_context: true  # Enable context injection (default: true)
    # injection_mode: Controls how much context is injected
    #   - auto: Adapts based on source (startup‚Üírich, resume‚Üístandard, compact‚Üícompact)
    #   - compact: ~150 tokens, high context survival for compaction
    #   - standard: ~400 tokens, best actionability for resumes
    #   - rich: ~800 tokens, full definitions/workflow for startups
    injection_mode: auto  # default: auto
    # custom_header: Optional project-specific header text
    # custom_header: "üöÄ Project-specific context here"

  # Stop hook - verifies requirements before session ends
  stop:
    verify_requirements: true  # Block session end if requirements unsatisfied

  # Agent Teams - team-based review with cross-validation (ADR-012)
  agent_teams:
    enabled: true           # Enabled by default
    keep_working_on_idle: false  # Exit 2 on TeammateIdle to re-engage idle teammates
    validate_task_completion: false  # Validate task output on TaskCompleted
    max_teammates: 4        # Token cost cap for team-based reviews
    fallback_to_subagents: true  # Graceful degradation when teams unavailable

  # Session Learning - analyzes sessions to improve future efficiency
  session_learning:
    enabled: false  # Set to true to enable session learning
    prompt_on_stop: true  # Prompt for /session-reflect before session ends
    min_tool_uses: 5  # Minimum tool uses before prompting for review
    # max_recommendations: 5  # Maximum recommendations per session
    # confidence_threshold: 0.7  # Only show recommendations above this confidence
    # update_targets:  # What can be updated by learning
    #   - memories  # .serena/memories/ files
    #   - skills    # Plugin skill files
    #   - commands  # Plugin command files (arguments only)
